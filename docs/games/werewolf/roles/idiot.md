# 白痴 (Idiot)

## 1. 角色概述

| 属性 | 值 |
|------|-----|
| **角色 ID** | `idiot` |
| **中文名称** | 白痴 |
| **英文名称** | Idiot / Fool |
| **阵营** | `village` (好人阵营) |
| **优先级** | `P1` (进阶角色) |
| **夜晚行动** | 无（被动角色） |
| **胜利条件** | 跟随村民阵营：消灭所有狼人（优先级 4） |
| **核心机制** | 白天首次被投票处决时翻牌免死，并永久失去投票权 |

**角色类型判断**：被动能力角色（无主动夜间技能，能力在白天投票结算时自动触发）。

---

## 2. 角色能力

### 2.1 核心能力：翻牌免死（一次）

当白痴在白天投票结算中成为被处决目标时：

1. 若白痴此前未触发过能力，则触发“翻牌免死”。
2. 白痴不会死亡，保持 `alive = true`。
3. 白痴身份对全场公开（翻牌）。
4. 白痴进入“失去投票权”状态，从下一次投票开始不可投票。

### 2.2 能力限制

- 该能力仅在**白天投票处决**触发。
- 该能力仅可触发**一次**。
- 触发后白痴依然可发言、依然可被投票、依然可被夜晚击杀。

### 2.3 不触发场景

以下死亡方式不触发翻牌免死：

- 狼人击杀（`wolf_kill`）
- 女巫毒杀（`witch_poison`）
- 猎人开枪（`hunter_shoot`）
- 殉情（`lover_death`）
- 已翻牌白痴再次被投票处决（`execution`）

---

## 3. 行动时机与优先级

### 3.1 夜间阶段

- 白痴无夜间行动。
- 不加入 `nightActionPriority`。
- 不加入 `pendingNightRoles`。

### 3.2 白天投票阶段

白痴能力在 `resolveVotes` 结算“处决目标”后立即判定，优先于常规死亡处理：

1. 计算投票结果，得到 `executed`。
2. 若 `executed` 是未翻牌白痴：
   - 执行翻牌免死逻辑。
   - 不调用死亡处理与死亡触发器。
   - 进入下一夜。
3. 否则按常规处决流程执行。

### 3.3 与现有流程的关系

- 白痴机制属于白天结算逻辑，不改变夜间流程。
- 不影响夜晚行动优先级（1/2/3/5/7/8/9/10/11/12）。

---

## 4. 数据结构

### 4.1 角色状态字段（`state.roleStates`）

```javascript
roleStates: {
  // ...existing role state fields
  idiotRevealedIds: string[] // 已触发翻牌免死且失去投票权的白痴玩家 ID 列表
}
```

### 4.2 公开身份字段（建议）

```javascript
publicRevealRoleIds: {
  [playerId: string]: true
}
```

用途：标记“白痴翻牌后应向全场公开角色”。

### 4.3 投票权判定（推导逻辑）

无需单独存储投票权表，按以下规则动态计算：

```javascript
canVote(playerId) =
  player.alive === true &&
  !(player.roleId === 'idiot' && roleStates.idiotRevealedIds.includes(playerId))
```

### 4.4 行动数据格式

白痴无主动行动，无新增 `ACTION_TYPES`，无新增 `nightActions` 数据结构。

---

## 5. 验证规则

### 5.1 日间投票验证（`validateDayVote`）

新增白痴约束：

- 若玩家在 `idiotRevealedIds` 中，返回：
  - `{ valid: false, error: '你已失去投票权' }`

### 5.2 投票队列构建（`startDayVote`）

- `voterQueue` 应过滤无投票权玩家（翻牌白痴）。
- 若仅白痴存活或所有可投票者为空，允许进入“无人投票”分支并按现有投票结算规则推进。

### 5.3 白痴翻牌触发验证

在 `resolveVotes` 内判断：

- `executedPlayer.roleId === 'idiot'`
- `executedPlayer.id` 不在 `idiotRevealedIds`

满足时触发翻牌免死，否则按常规处决。

### 5.4 错误消息规范

- 无投票权提示：`你已失去投票权`
- 其余复用现有投票验证错误。

---

## 6. 解析逻辑

### 6.1 白天投票结算伪代码

```javascript
function resolveVotes(state) {
  const result = calculateVoteResult(state.votes, state.options);

  if (!result.executed) {
    // tie / no execution branch
    // existing logic
    return;
  }

  const executedId = result.executed;
  const executedPlayer = state.playerMap[executedId];
  const isFirstRevealIdiot =
    executedPlayer.roleId === 'idiot' &&
    !state.roleStates.idiotRevealedIds.includes(executedId);

  if (isFirstRevealIdiot) {
    state.roleStates.idiotRevealedIds.push(executedId);
    state.publicRevealRoleIds[executedId] = true;

    // not dead, no death triggers
    state.lastDayExecution = null;
    transitionPhase(state, PHASES.NIGHT, helpers);
    return;
  }

  // normal execution
  markPlayerDead(executedId, 'execution');
  processDeathTriggers([executedId], 'execution');
  transitionPhase(...);
}
```

### 6.2 夜晚结算

- 夜晚对白痴无特殊分支。
- 若白痴夜晚死亡，按常规死亡处理。

### 6.3 可见信息

- 白痴翻牌后，所有玩家应可见其角色为 `idiot`。
- 白痴自身可见 `idiotRevealed = true`（用于 UI 提示“失去投票权”）。

---

## 7. 与其他角色的交互

### 7.1 与狼人

- 白痴被狼刀时正常死亡，不触发翻牌免死。
- 白痴翻牌后仍可被狼刀。

### 7.2 与女巫

- 白痴被毒杀时正常死亡。
- 白痴翻牌状态不免疫女巫毒药。

### 7.3 与猎人

- 白痴被猎人开枪带走时正常死亡。
- 若白痴先翻牌再被枪杀，同样正常死亡。

### 7.4 与医生 / 守卫

- 正常保护夜间攻击目标，和白痴机制无冲突。
- 保护的是“夜间死亡事件”，不影响“白天翻牌免死”。

### 7.5 与丘比特（恋人机制）

- 白痴若是恋人：
  - 首次被处决翻牌免死时，不触发殉情（因为未死亡）。
  - 若后续真正死亡（夜死或二次处决），可触发恋人殉情。

### 7.6 与遗言系统

- 首次处决翻牌免死不应进入死亡队列，不占用遗言名额。
- 二次处决或夜晚死亡时，按现有遗言规则处理。

---

## 8. 边界情况

1. **首日首票即处决白痴**：应翻牌免死并失去投票权。
2. **翻牌白痴再次被处决**：应正常死亡。
3. **翻牌白痴尝试投票**：验证失败，提示失去投票权。
4. **翻牌白痴仍在 voterQueue**（错误状态）: 队列构建必须过滤，避免轮到其投票。
5. **白痴被夜晚击杀后，白天不应翻牌触发**：因已死亡。
6. **白痴与恋人绑定且首次被处决**：不触发恋人殉情。
7. **白痴与恋人绑定且二次被处决**：触发死亡与殉情链。
8. **平票无处决日**：白痴能力不触发。
9. **无投票权玩家较多导致 voterQueue 为空**：流程应继续，不死锁。
10. **角色公开与死亡公开设置并存**：白痴翻牌公开应独立于 `revealRolesOnDeath`。

---

## 9. 配置选项

当前建议：**不新增配置项**，保持规则固定，降低实现复杂度。

| 选项 | 默认值 | 说明 |
|------|--------|------|
| （无） | - | 白痴规则固定：首次白天处决免死 + 失去投票权 |

可扩展项（暂不实现，仅记录）：

| 候选选项 | 类型 | 可能默认值 | 说明 |
|----------|------|------------|------|
| `idiotRevealsOnExecution` | boolean | `true` | 是否在首次被处决时翻牌免死 |
| `idiotLosesVoteAfterReveal` | boolean | `true` | 翻牌后是否失去投票权 |

---

## 10. UI 呈现与交互方式

### 选择模式

`none` — 白痴无主动行动，能力被动触发，无需选择目标。

### 夜间面板内容

无夜间面板。白痴在夜晚阶段不行动。

### 操作栏按钮

- **白天投票阶段**：翻牌后的白痴操作栏显示 `你已失去投票权`（禁用状态）
- **其他阶段**：与普通村民相同

### 徽章显示

无专属徽章。白痴翻牌后身份通过角色公开信息展示（`publicRevealRoleIds`），所有玩家可在座位图上看到其角色。

### 可见状态字段

`_getVisibleRoleStates` 中暴露：

- `idiotRevealed`: 当前玩家是否已翻牌（布尔值）
- `idiotRevealedIds`: 所有已翻牌白痴的 ID 列表（所有玩家可见，用于投票权判定）

### 白天 UI 影响

- **投票队列构建**：翻牌白痴不出现在 `voterQueue` 中
- **投票按钮**：翻牌白痴的操作栏显示"你已失去投票权"而非投票/弃票按钮
- **发言权**：翻牌白痴仍可正常发言，不受影响

---

## 11. 测试场景

以下为 Phase 3 建议测试清单（共 34 条）。

### 11.1 基础功能（1-10）

1. 白痴首次被白天处决时不死亡。
2. 首次处决后白痴进入已翻牌状态。
3. 首次处决后白痴身份对全场可见。
4. 首次处决后 `deathCause` 不应为 `execution`。
5. 首次处决后不触发死亡触发器（如猎人链）。
6. 首次处决后直接进入下一夜流程。
7. 白痴二次被处决时正常死亡。
8. 二次被处决时 `deathCause` 为 `execution`。
9. 白痴夜晚被狼刀时正常死亡。
10. 白痴夜晚被毒杀时正常死亡。

### 11.2 验证与投票流程（11-20）

11. 翻牌白痴执行 `DAY_VOTE` 被拒绝。
12. 翻牌白痴执行 `DAY_SKIP_VOTE` 也被拒绝。
13. 翻牌白痴不应出现在 `voterQueue`。
14. 翻牌白痴不应成为 `currentVoter`。
15. 非白痴玩家投票行为不受影响。
16. 平票进入二轮发言时，翻牌白痴仍可发言。
17. 二轮投票队列仍应过滤翻牌白痴。
18. 全体可投票玩家弃票时流程正常进入夜晚。
19. 仅剩翻牌白痴无投票权时流程不死锁。
20. 无投票权错误消息文案正确。

### 11.3 角色交互（21-29）

21. 白痴被守卫保护时夜晚狼刀无效（白痴仍存活）。
22. 白痴被医生保护时夜晚狼刀无效。
23. 白痴被女巫毒杀时保护不生效（按现有规则）。
24. 白痴被猎人射杀时正常死亡。
25. 白痴（恋人）首次被处决翻牌时不触发殉情。
26. 白痴（恋人）二次处决死亡时触发殉情。
27. 白痴（恋人）夜死时触发殉情。
28. 白痴翻牌后狼人视角可确认其身份公开。
29. 白痴翻牌后好人视角可确认其身份公开。

### 11.4 边界与回归（30-34）

30. 多白痴局（扩展规则）中每名白痴均可独立触发一次。
31. 首次处决白痴当日 `lastDayExecution` 应为 null/无人处决语义。
32. 已翻牌白痴死亡后不应再次参与投票队列计算。
33. 游戏结束判定不受白痴翻牌状态影响（仍按存活阵营计算）。
34. 历史日志中应记录白痴翻牌事件（便于回放与排错）。

---

## Phase 1 完成检查

- [x] 10 个章节完整
- [x] 边界情况 ≥ 5（已提供 10 个）
- [x] 测试场景 ≥ 30（已提供 34 个）
- [x] 数据结构清晰定义
- [x] 优先级与时机说明清晰
