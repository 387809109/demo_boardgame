# 预言家 (Seer)

## 1. 角色基本信息

| 属性 | 值 |
|------|-----|
| **角色 ID** | `seer` |
| **中文名称** | 预言家 |
| **英文名称** | Seer |
| **阵营** | `village` (好人阵营) |
| **优先级** | `P0` (基础角色) |
| **夜晚行动** | `NIGHT_SEER_CHECK` |
| **胜利条件** | 跟随村民阵营：消灭所有狼人（优先级 4） |
| **行动时机** | 每个夜晚 |

---

## 2. 核心规则

### 2.1 夜晚查验

- **每夜查验**：预言家在每个夜晚行动一次
- **选择目标**：选择一名**存活的其他玩家**进行查验
- **不能查验自己**：`targetId === playerId` 时验证失败，返回错误"不能查验自己"
- **无连续查验限制**：可以对同一名玩家重复查验（不同夜晚）

### 2.2 查验结果传递

查验结果通过 `dayAnnouncements` 传递，类型为 `seer_result`：

```javascript
state.dayAnnouncements.push({
  type: 'seer_result',
  playerId,             // 预言家的 playerId
  targetId: actionData.targetId,
  result: target.team   // 'village' 或 'werewolf'
});
```

- 查验结果在**当晚结算时**生成，在下一个白天阶段（或夜间面板中）展示给预言家
- 仅预言家本人可见，其他玩家不可见

### 2.3 查验记录存储

所有查验结果存储在 `state.seerChecks` 中：

```javascript
state.seerChecks[targetId] = team;  // 'village' 或 'werewolf'
```

- `seerChecks` 是累积的，记录预言家历史上所有的查验结果
- 仅预言家可见：`getVisibleState` 中通过 `viewer?.roleId === 'seer'` 判断，非预言家获得空对象 `{}`

### 2.4 查验结果判定规则

查验结果使用目标玩家的 `team` 字段：

| 目标角色 | 查验结果 | 说明 |
|----------|----------|------|
| 狼人 (werewolf) | `'werewolf'` | 显示为"狼人" |
| 村民 (villager) | `'village'` | 显示为"好人" |
| 医生 (doctor) | `'village'` | 好人阵营角色 |
| 猎人 (hunter) | `'village'` | 好人阵营角色 |
| 女巫 (witch) | `'village'` | 好人阵营角色 |
| 守卫 (bodyguard) | `'village'` | 好人阵营角色 |
| 白痴 (idiot) | `'village'` | 好人阵营角色 |

**重要**：查验结果基于角色初始的 `roleConfig.team`（即角色配置中的原始阵营），而非当前 `player.team`。当丘比特将狼人与好人连结为恋人时，恋人的 `player.team` 可能被修改为 `'lovers'`，但查验结果应始终反映原始角色阵营。

---

## 3. 可选规则设定

预言家**无特殊可选规则配置项**。

其行为完全由核心规则决定：
- 每晚查验一名存活玩家
- 不能查验自己
- 无连续查验限制
- 查验结果仅预言家可见

---

## 4. 夜晚行动优先级分析

根据 `config.json` 的 `nightActionPriority` 表：

| 优先级 | 角色 | 操作 |
|--------|------|------|
| 1 | Cupid | 连结恋人 (仅首夜) |
| 5 | **Seer** / Detective | **查验** |
| 7 | Doctor / Bodyguard / Guardian Angel | 保护 |
| 8 | Werewolf | 击杀 |
| 9 | Vigilante / Serial Killer | 射杀 |
| 10 | Witch | 救人/毒杀 |

### 优先级设计理由

1. **预言家先于保护角色（5 < 7）**：
   - 预言家的查验是纯信息获取行为，不影响其他角色的行动结果
   - 无论预言家查验谁，都不会改变保护/击杀的结算逻辑

2. **预言家先于狼人（5 < 8）**：
   - 预言家在狼人行动前提交查验，查验结果不受当晚狼刀目标影响
   - 即使预言家当晚被狼刀杀死，其查验结果仍然生成并记录

3. **预言家是最早行动的 P0 主动技能角色**：
   - 在 P0 角色中，预言家（priority 5）早于医生（priority 7）和狼人（priority 8）
   - 这反映了查验行为的"无副作用"特性——纯信息获取不需要等待其他行动结果

4. **与侦探同级（priority 5）**：
   - 侦探（detective）是 P2 角色，与预言家同属查验类角色
   - 两者共享相同优先级，因为查验行为互不干扰

---

## 5. 与现有角色的交互

### 5.1 预言家 vs 狼人（Werewolf）

| 场景 | 结果 |
|------|------|
| 预言家查验狼人 | 查验结果为"狼人" (`'werewolf'`) |
| 狼人击杀预言家 | 预言家死亡，下一晚无法行动 |
| 预言家当晚被狼刀，同时完成查验 | 查验结果**仍然生效**（priority 5 < 8，查验在狼刀之前结算） |

---

### 5.2 预言家 vs 村民（Villager）

| 场景 | 结果 |
|------|------|
| 预言家查验村民 | 查验结果为"好人" (`'village'`) |

- **无其他交互**

---

### 5.3 预言家 vs 医生（Doctor）

| 场景 | 结果 |
|------|------|
| 预言家查验医生 | 查验结果为"好人" (`'village'`) |
| 医生保护预言家，狼人击杀预言家 | 预言家**存活** |
| 医生保护预言家，女巫毒杀预言家 | 预言家**死亡**（医生无法阻止毒药） |

---

### 5.4 预言家 vs 猎人（Hunter）

| 场景 | 结果 |
|------|------|
| 预言家查验猎人 | 查验结果为"好人" (`'village'`) |
| 猎人死亡后开枪射杀预言家 | 预言家死亡 |

- **无其他直接交互**

---

### 5.5 预言家 vs 女巫（Witch）

| 场景 | 结果 |
|------|------|
| 预言家查验女巫 | 查验结果为"好人" (`'village'`) |
| 预言家被狼刀，女巫使用解药 | 预言家**存活** |
| 女巫对预言家使用毒药 | 预言家**死亡** |
| 预言家被狼刀 + 女巫毒药 | 预言家**死亡**（即使解药和毒药同时使用） |

---

### 5.6 预言家 vs 守卫（Bodyguard）

| 场景 | 结果 |
|------|------|
| 预言家查验守卫 | 查验结果为"好人" (`'village'`) |
| 守卫守护预言家，狼人击杀预言家 | 预言家**存活** |
| 守卫守护预言家，女巫毒杀预言家 | 预言家**死亡**（守卫无法阻止毒药） |

---

### 5.7 预言家 vs 白痴（Idiot）

| 场景 | 结果 |
|------|------|
| 预言家查验白痴 | 查验结果为"好人" (`'village'`) |
| 预言家查验已翻牌的白痴 | 查验结果仍为"好人"（翻牌不改变阵营） |

---

### 5.8 预言家 vs 丘比特（Cupid）与恋人机制

| 场景 | 结果 |
|------|------|
| 预言家查验丘比特 | 查验结果为"好人" (`'village'`) |
| 预言家查验被丘比特连结的好人恋人 | 查验结果为"好人"（使用原始 roleConfig.team） |
| 预言家查验被丘比特连结的狼人恋人 | 查验结果为**"狼人"**（使用原始 roleConfig.team，不受 `player.team` 被改为 `'lovers'` 影响） |
| 预言家是恋人之一 | 预言家正常查验，胜利条件可能变为恋人胜利 |

**关键点**：丘比特跨阵营连结会将恋人双方的 `player.team` 修改为 `'lovers'`，但预言家查验应基于原始角色配置中的阵营（`roleConfig.team`），确保狼人恋人仍被查验为"狼人"。

---

## 6. Edge Cases（易错情境与正确结算）

### 6.1 预言家查验已翻牌的白痴

| 场景 | 结果 |
|------|------|
| 白痴已被投票处决并翻牌（`revealed: true`） | 查验结果仍为"好人"（`'village'`） |

**说明**：白痴翻牌是公开信息，但预言家的查验机制不受翻牌状态影响，始终返回目标的原始阵营。

---

### 6.2 预言家查验狼人恋人

| 场景 | 结果 |
|------|------|
| 狼人被丘比特连结为恋人，`player.team` 已改为 `'lovers'` | 查验结果为**"狼人"**（使用原始 `roleConfig.team`） |

**关键**：这是最容易出错的 Edge Case。实现时必须确保查验结果取自角色配置的原始阵营，而非运行时可能被修改的 `player.team`。

---

### 6.3 预言家当晚被杀但查验仍生效

| 事件 | 优先级 | 结果 |
|------|--------|------|
| 预言家查验目标 | 5 | 查验结果生成并记录到 `seerChecks` |
| 狼人击杀预言家 | 8 | 预言家死亡 |

**结果**：
- 查验结果在 `dayAnnouncements` 中生成（priority 5 在 priority 8 之前结算）
- 预言家虽然死亡，其最后一次查验结果仍然会被记录到 `state.seerChecks`
- 该查验结果会在夜间面板中展示（如果 UI 在结算前渲染），但预言家已死亡，实际意义在于状态完整性

---

### 6.4 预言家重复查验同一目标

| 场景 | 结果 |
|------|------|
| 预言家第 1 晚查验玩家 A，结果为"好人" | `seerChecks[A] = 'village'` |
| 预言家第 3 晚再次查验玩家 A | `seerChecks[A] = 'village'`（覆盖写入，结果不变） |

**说明**：
- 验证逻辑不阻止重复查验
- `seerChecks` 中的值会被覆盖（但结果相同）
- 这是合法行为，玩家可能出于策略考虑重复验证

---

### 6.5 所有狼人均被预言家查验

| 场景 | 结果 |
|------|------|
| 预言家通过多晚查验发现了所有狼人 | 无特殊机制触发 |

**说明**：
- 预言家获得完整信息，但游戏不会因此自动结束
- 胜利条件仍然是"消灭所有狼人"（通过投票或其他手段）
- 预言家需要在白天发言说服其他玩家投票

---

### 6.6 预言家被女巫毒杀的同一晚进行查验

| 事件 | 优先级 | 结果 |
|------|--------|------|
| 预言家查验目标 | 5 | 查验结果生成 |
| 女巫毒杀预言家 | 10 | 预言家死亡 |

**结果**：查验结果**仍然生效**。预言家的行动（priority 5）在女巫行动（priority 10）之前结算，因此查验已经完成。

---

### 6.7 预言家查验目标但目标同晚死亡

| 场景 | 结果 |
|------|------|
| 预言家查验玩家 A，同晚狼人击杀玩家 A | 查验结果正常生成（`seerChecks[A] = team`），目标死亡不影响查验 |
| 预言家查验玩家 A，同晚女巫毒杀玩家 A | 查验结果正常生成 |

**说明**：查验是信息获取行为，不受目标是否在同一晚死亡的影响。

---

## 7. 测试场景清单

### 7.1 基础查验功能测试（6 个用例）

1. ✅ 预言家查验狼人，结果为"狼人"
2. ✅ 预言家查验村民，结果为"好人"
3. ✅ 预言家查验医生，结果为"好人"
4. ✅ 预言家查验猎人，结果为"好人"
5. ✅ 预言家查验女巫，结果为"好人"
6. ✅ 预言家查验守卫，结果为"好人"

---

### 7.2 查验限制验证测试（4 个用例）

7. ✅ 预言家查验自己 → 验证失败（`targetId === playerId`）
8. ✅ 预言家查验已死亡玩家 → 验证失败（目标必须存活）
9. ✅ 预言家查验不存在的 playerId → 验证失败
10. ✅ 预言家在非夜晚阶段提交 `NIGHT_SEER_CHECK` → 验证失败

---

### 7.3 重复查验测试（3 个用例）

11. ✅ 预言家第 1 晚查验玩家 A，第 2 晚再次查验玩家 A → 允许，结果一致
12. ✅ 预言家连续 3 晚查验同一名狼人 → 均返回"狼人"
13. ✅ `seerChecks` 累积记录多个不同目标的查验结果

---

### 7.4 查验结果传递测试（4 个用例）

14. ✅ 查验结果出现在 `dayAnnouncements` 中，类型为 `seer_result`
15. ✅ `dayAnnouncements` 中的 `result` 字段为 `'village'` 或 `'werewolf'`
16. ✅ `seerChecks` 正确存储查验记录（`seerChecks[targetId] = team`）
17. ✅ `getVisibleState` 中仅预言家可见 `seerChecks`，其他角色获得空对象

---

### 7.5 预言家死亡相关测试（5 个用例）

18. ✅ 预言家被狼刀杀死的同一晚，查验结果仍然生成
19. ✅ 预言家被女巫毒杀的同一晚，查验结果仍然生成
20. ✅ 预言家死亡后，下一晚无 `NIGHT_SEER_CHECK` 行动步骤
21. ✅ 预言家死亡后，`seerChecks` 历史记录保留（不清空）
22. ✅ 预言家被猎人开枪射杀（白天），下一晚无法行动

---

### 7.6 与其他角色交互测试（6 个用例）

23. ✅ 预言家被狼刀，医生保护 → 预言家存活，查验正常
24. ✅ 预言家被狼刀，守卫守护 → 预言家存活，查验正常
25. ✅ 预言家被狼刀，女巫解药 → 预言家存活
26. ✅ 预言家查验被丘比特连结的狼人恋人 → 结果为"狼人"（使用原始 roleConfig.team）
27. ✅ 预言家查验被丘比特连结的好人恋人 → 结果为"好人"
28. ✅ 预言家查验已翻牌的白痴 → 结果为"好人"

---

### 7.7 Edge Cases 测试（5 个用例）

29. ✅ 预言家查验目标，目标同晚被狼刀杀死 → 查验结果仍生成
30. ✅ 预言家查验目标，目标同晚被女巫毒死 → 查验结果仍生成
31. ✅ 预言家当晚被杀，查验结果记录到 `seerChecks` → 状态完整
32. ✅ 所有狼人被查验后游戏不自动结束，仍需投票消灭
33. ✅ `seerChecks` 在多轮游戏中正确累积，不丢失历史记录

---

### 7.8 多轮游戏测试（3 个用例）

34. ✅ 预言家连续 5 晚查验不同目标，`seerChecks` 记录 5 条
35. ✅ 预言家查验序列：A → B → A → C（重复查验不影响其他记录）
36. ✅ 预言家在游戏中被投票处决，后续无查验行动

---

**预计测试用例总数**：36 个

---

## 8. 配置建议

预言家无需在 `config.json` 的 `rules` 或 `settingsSchema` 中添加专属配置项。

已有配置（在 `config.json` 中）：

```json
{
  "roles": {
    "p0": {
      "seer": {
        "id": "seer",
        "name": "预言家",
        "team": "village",
        "priority": "P0"
      }
    }
  },
  "nightActionPriority": [
    { "priority": 5, "roles": ["seer", "detective"], "description": "查验" }
  ]
}
```

**说明**：
- 预言家作为 P0 基础角色，行为规则固定
- 不提供"是否允许重复查验"等可选配置（始终允许）
- 不提供"是否允许查验自己"等可选配置（始终禁止）
- 如未来需要变体规则（如"首夜无法查验"），可在 `settingsSchema` 中扩展

---

## 9. 实现检查清单

- [ ] 在 `config.json` 的 `roles.p0` 中确认 `seer` 角色定义存在
- [ ] 在 `config.json` 的 `nightActionPriority` 中确认 `seer` 为 priority 5
- [ ] 在 `rules.js` 中实现 `NIGHT_SEER_CHECK` 验证（`targetId !== playerId`，目标存活）
- [ ] 在 `index.js` 的 `resolveNightActions` 中实现查验结果生成逻辑
- [ ] 在 `index.js` 中初始化 `state.seerChecks = {}`
- [ ] 在 `index.js` 的 `getVisibleState` 中仅对 `roleId === 'seer'` 暴露 `seerChecks`
- [ ] 查验结果推送到 `state.dayAnnouncements`，类型为 `seer_result`
- [ ] 确保查验结果使用原始 `roleConfig.team`（而非可能被修改的 `player.team`）
- [ ] 在 `ui-panels-night.js` 中实现预言家夜间面板（查验结果展示 + 目标选择提示）
- [ ] 在 `ui-panels-night.js` 中实现 `renderSeerResult` 组件（好人/狼人结果展示）
- [ ] 在 UI 中实现 `seerChecks` 徽章显示（已查验玩家标记好人/狼人）
- [ ] 在 `index.test.js` 中添加 36 个测试用例
- [ ] 手动测试验证所有 Edge Cases

---

## 10. UI 呈现与交互方式

### 选择模式

`single` — 通过环形座位图点击单个玩家头像选择查验目标。

预言家已在 `roleHasNightAction()` 中注册，框架自动通过 `_getNightSelectionConfig()` 提供环形单选。

### 夜间面板内容

面板文件：`ui-panels-night.js` → 预言家分支（`case 'seer'`）

显示内容：

- **上次查验结果**：若 `dayAnnouncements` 中存在当前预言家的 `seer_result`，调用 `renderSeerResult(ctx, seerResult)` 渲染上一晚的查验结果
  - 好人结果：绿色文字显示"{玩家名} 是 **好人**"
  - 狼人结果：红色文字显示"{玩家名} 是 **狼人**"
- **操作提示**：显示"点击环形布局中的玩家头像选择要查验的玩家"
- **已选择状态**：若已点选目标，显示选中的玩家名

### 操作栏按钮

- **确认行动**：选择目标后启用
  - 按钮文案：`确认行动`
  - 启用条件：`selectedTarget !== null`

### 徽章显示

预言家可在环形座位图中看到已查验玩家的身份徽章：

| 查验结果 | 徽章样式 |
|----------|----------|
| `'village'`（好人） | 绿色标记 / "好人" 文字 |
| `'werewolf'`（狼人） | 红色标记 / "狼人" 文字 |

徽章数据来源：`state.seerChecks`，通过 `getDisplayName()` 函数在渲染时判断是否附加身份信息。

**仅预言家可见**：其他角色的 `seerChecks` 为空对象，不会看到任何徽章。

### 可见状态字段

`getVisibleState` 中暴露给预言家玩家：

- `seerChecks`: 历史查验记录对象 `{ [targetId]: 'village' | 'werewolf' }`

### 白天 UI 影响

无特殊白天 UI 变化。预言家在白天发言阶段可自由选择是否公开查验结果（纯玩家决策，无系统机制）。

---

## 11. 参考资料

- **经典狼人杀规则**：[百度百科 - 狼人杀](https://baike.baidu.com/item/狼人杀)
- **预言家角色说明**：经典狼人杀核心角色，几乎所有版本均包含
- **相关角色**：侦探（detective, P2）— 高级查验角色，与预言家共享 priority 5
- **项目规则文档**：`docs/games/werewolf/RULES.md` — 完整游戏规则技术规范

---

**文档版本**：v1.0
**创建日期**：2026-02-22
**作者**：AI-assisted
**待审核**：✅ 请确认规则设定是否符合预期
