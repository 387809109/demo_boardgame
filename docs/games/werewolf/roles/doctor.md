# 医生 (Doctor)

## 1. 角色基本信息

| 属性 | 值 |
|------|-----|
| **角色 ID** | `doctor` |
| **中文名称** | 医生 |
| **英文名称** | Doctor |
| **阵营** | `village` (好人阵营) |
| **优先级** | `P0` (基础角色) |
| **夜晚行动** | `NIGHT_DOCTOR_PROTECT` |
| **胜利条件** | 跟随村民阵营：消灭所有狼人（优先级 4） |
| **行动时机** | 每个夜晚（在狼人击杀之前） |

---

## 2. 核心规则

### 2.1 基本功能

- **每夜保护**：医生在每个夜晚行动一次
- **选择目标**：可以选择一名存活玩家进行保护（是否包括自己取决于配置）
- **保护效果**：如果被保护的玩家当晚被狼人袭击（`NIGHT_WOLF_KILL`），该玩家不会死亡
- **优先级**：医生的保护行动在狼人击杀**之前**执行（priority 7 vs 8）

### 2.2 保护机制

医生的保护仅对 `bypassesProtection = false` 的击杀生效（即**狼人击杀**），不能阻止：
- 女巫的毒药（`NIGHT_WITCH_POISON`）
- 义警的射杀（`NIGHT_VIGILANTE_KILL`）
- 其他带有 `bypassesProtection = true` 的致死效果

### 2.3 状态追踪

- `roleStates.doctorLastProtect`：记录医生上一晚保护的目标 ID
- 每次夜晚结算后更新该字段，用于连续保护验证

---

## 3. 可选规则设定

医生的行为受以下游戏配置影响：

### 3.1 是否允许自救 (`allowDoctorSelfProtect`)

| 配置值 | 行为 |
|--------|------|
| `true` | 医生可以保护自己 |
| `false` | 医生只能保护其他玩家 |

**推荐默认值**: `true`

**验证逻辑**：
- 当 `allowDoctorSelfProtect = false` 时，`targetId === playerId` 返回验证错误："医生不能保护自己"

---

### 3.2 是否允许连续保护同一人 (`allowRepeatedProtect`)

| 配置值 | 行为 |
|--------|------|
| `true` | 医生可以连续多晚保护同一名玩家 |
| `false` | 医生不能连续两晚保护同一名玩家 |

**推荐默认值**: `false` （防止医生一直保护关键角色如预言家）

**验证逻辑**：
- 记录上一晚的保护目标 `doctorLastProtect`
- 当 `allowRepeatedProtect = false` 且 `targetId === doctorLastProtect` 时，返回验证错误："不能连续两晚保护同一人"

---

## 4. 夜晚行动优先级分析

根据 `RULES.md` 的夜晚行动优先级表：

| 优先级 | 角色 | 操作 |
|--------|------|------|
| 7 | **Doctor / Bodyguard / Guardian Angel** | 保护 |
| 8 | Werewolf | 击杀 |
| 10 | Witch | 救人/毒杀 |

### 优先级设计理由

1. **医生先于狼刀（7 < 8）**：
   - 医生的保护是"预设屏障"，在狼刀执行前生效
   - 当狼人选择目标时，医生已经完成保护设置

2. **医生先于女巫（7 < 10）**：
   - 女巫在狼刀结算后才得知被刀目标
   - 女巫可以看到"被狼刀但被医生保护"的结果
   - 女巫可以选择是否对已被医生保护的目标使用解药

3. **与守卫同级（priority 7）**：
   - 医生和守卫的保护机制类似（都是预设保护）
   - 医生是 P0 基础角色，守卫是 P1 增强版
   - 如果同时存在，两者保护不冲突（都生效）

---

## 5. 与现有角色的交互

### 5.1 医生 vs 狼人（Werewolf）

| 场景 | 结果 |
|------|------|
| 医生保护玩家 A，狼人击杀玩家 A | 玩家 A **存活**（医生阻止了狼刀） |
| 医生保护玩家 A，狼人击杀玩家 B | 玩家 B **死亡**（医生保护无效） |
| 医生死亡，无法保护 | 当晚无医生保护 |

---

### 5.2 医生 vs 女巫（Witch）

#### 场景 1：女巫毒药 vs 医生保护
- 女巫对玩家 B 使用毒药
- 医生保护玩家 B
- **结果**：玩家 B **死亡**（医生无法阻止毒药，毒药 `bypassesProtection = true`）

#### 场景 2：女巫解药救医生
- 狼人击杀医生
- 女巫使用解药救医生
- **结果**：医生 **存活**

#### 场景 3：女巫毒杀医生
- 女巫对医生使用毒药
- **结果**：医生 **死亡**（无法自保，毒药绕过保护机制）

---

### 5.3 医生 vs 义警（Vigilante）

| 场景 | 结果 |
|------|------|
| 义警射杀玩家 A，医生保护玩家 A | 玩家 A **死亡**（医生无法阻止义警射杀，`bypassesProtection = true`） |
| 义警射杀医生 | 医生 **死亡** |

---

### 5.4 医生 vs 守卫（Bodyguard）

| 场景 | 结果 |
|------|------|
| 医生保护玩家 A，守卫守护玩家 A，狼人击杀 A | 玩家 A **存活**（两者保护叠加，不冲突） |
| 医生保护玩家 A，守卫守护玩家 B，狼人击杀 A | 玩家 A **存活**（医生保护生效） |
| 医生保护玩家 A，守卫守护玩家 B，狼人击杀 B | 玩家 B **存活**（守卫保护生效） |

**注意**：医生和守卫共用 `allowDoctorSelfProtect` 和 `allowRepeatedProtect` 配置。

---

### 5.5 医生 vs 预言家（Seer）

- **预言家查验医生**：结果为"好人"（`village` 阵营）
- **医生保护预言家**：可以保护预言家不被狼刀
- **无其他特殊交互**

---

### 5.6 医生 vs 猎人（Hunter）

#### 场景 1：医生保护猎人，狼人击杀猎人
- 狼人击杀猎人
- 医生保护猎人
- **结果**：猎人存活，**不触发开枪**

#### 场景 2：女巫毒死医生保护的猎人
- 女巫对猎人使用毒药
- 医生保护猎人
- **结果**：猎人死亡（毒药无视医生保护），**触发开枪**

---

## 6. Edge Cases（易错情境与正确结算）

### 6.1 医生自救

| `allowDoctorSelfProtect` | 场景 | 结果 |
|--------------------------|------|------|
| `true` | 医生保护自己，狼人击杀医生 | 医生 **存活** |
| `true` | 医生保护自己，女巫毒杀医生 | 医生 **死亡**（毒药绕过保护） |
| `false` | 医生试图保护自己 | **验证失败**，行动被拒绝 |

---

### 6.2 医生 + 守卫保护同一目标

| 场景 | 结果 |
|------|------|
| 医生保护玩家 A，守卫守护玩家 A，狼人击杀 A | 玩家 A **存活**（双重保护不冲突，`protectedIds` 包含 A） |
| 医生保护玩家 A，守卫守护玩家 A，女巫毒杀 A | 玩家 A **死亡**（两者保护都无法阻止毒药） |

---

### 6.3 医生保护被狼人选中的玩家

- 狼人击杀玩家 A
- 医生保护玩家 A
- **结算流程**：
  1. 收集保护事件：`protectedIds = {A}`
  2. 收集击杀事件：`wolf_kill` 目标 A，`bypassesProtection = false`
  3. 检查 `!kill.bypassesProtection && protectedIds.has(A)` → `true`
  4. 取消该击杀
- **结果**：玩家 A **存活**

---

### 6.4 医生当晚死亡

| 场景 | 结果 |
|------|------|
| 医生被狼刀（未自救） | 医生死亡，当晚医生已提交的保护行动**仍然生效**（priority 7 先于 8） |
| 医生被女巫毒杀 | 医生死亡，当晚医生已提交的保护行动**仍然生效**（priority 7 先于 10） |
| 医生白天被投票处决 | 下一晚无医生保护 |

**重要**：夜晚行动是"并发提交，按优先级结算"，医生在死亡前已经提交了保护行动。

---

### 6.5 狼人空刀（无人被杀）

| 场景 | 结果 |
|------|------|
| 狼人投票平票（或全部弃票），当晚无人被狼刀 | 医生的保护无效（无攻击事件可阻挡） |
| 女巫看到"无人被刀" | 女巫不能使用解药（无目标） |

---

### 6.6 医生自守与连续保护的组合

| `allowDoctorSelfProtect` | `allowRepeatedProtect` | 场景 | 是否合法 |
|--------------------------|------------------------|------|----------|
| `true` | `true` | 医生连续 3 晚保护自己 | 合法 |
| `true` | `false` | 医生连续 2 晚保护自己 | 非法（第 2 晚验证失败） |
| `false` | `true` | 医生第 1 晚保护自己 | 非法（验证失败） |
| `false` | `false` | 医生第 1 晚保护 A，第 2 晚保护 A | 非法（第 2 晚验证失败） |

**验证顺序**：
1. 先检查 `allowDoctorSelfProtect`
2. 再检查 `allowRepeatedProtect`

---

### 6.7 医生保护的玩家同时被多种方式攻击

| 攻击方式 | 是否被医生阻止 |
|----------|----------------|
| 狼人击杀 (`NIGHT_WOLF_KILL`, `bypassesProtection = false`) | 是 |
| 女巫毒药 (`NIGHT_WITCH_POISON`, `bypassesProtection = true`) | 否 |
| 义警射杀 (`NIGHT_VIGILANTE_KILL`, `bypassesProtection = true`) | 否 |

**场景示例**：
- 狼人击杀玩家 A
- 医生保护玩家 A
- 女巫对玩家 A 使用毒药
- **结果**：玩家 A 死亡（医生只阻止了狼刀，毒药仍然生效）

---

## 7. 测试场景清单

### 7.1 基础功能测试（6 个用例）

1. 医生保护成功阻止狼刀
2. 医生保护无效（狼刀目标不是医生保护的玩家）
3. 医生保护无法阻止女巫毒药
4. 医生自救（`allowDoctorSelfProtect = true`）
5. 医生自救被拒绝（`allowDoctorSelfProtect = false`）
6. 医生死亡后无法行动

---

### 7.2 连续保护测试（4 个用例）

7. 医生连续两晚保护同一人（`allowRepeatedProtect = true`）
8. 医生连续两晚保护同一人被拒绝（`allowRepeatedProtect = false`）
9. 医生第 1 晚保护 A，第 2 晚保护 B，第 3 晚再保护 A（`allowRepeatedProtect = false`）
10. 医生连续自救被拒绝（`allowDoctorSelfProtect = true, allowRepeatedProtect = false`）

---

### 7.3 与狼人交互测试（4 个用例）

11. 医生保护目标与狼刀目标一致 → 目标存活
12. 医生保护目标与狼刀目标不一致 → 狼刀目标死亡
13. 狼人空刀（平票），医生保护无效
14. 医生被狼刀（未自救）→ 医生死亡，当晚保护仍生效

---

### 7.4 与女巫交互测试（5 个用例）

15. 女巫毒杀医生保护的目标 → 目标死亡
16. 女巫解药救医生 → 医生存活
17. 女巫毒杀医生 → 医生死亡
18. 医生保护 A + 女巫解药救 A（A 被狼刀） → A 存活
19. 医生保护 A，女巫毒杀 A + 狼人击杀 A → A 死于毒药

---

### 7.5 与义警交互测试（2 个用例）

20. 义警射杀医生保护的目标 → 目标死亡（`bypassesProtection = true`）
21. 义警射杀医生 → 医生死亡

---

### 7.6 与守卫交互测试（3 个用例）

22. 医生 + 守卫同时保护同一目标，狼刀该目标 → 目标存活（双重保护不冲突）
23. 医生保护 A，守卫守护 B，狼刀 A → A 存活
24. 医生保护 A，守卫守护 B，狼刀 B → B 存活

---

### 7.7 与预言家交互测试（2 个用例）

25. 预言家查验医生 → 结果为"好人"
26. 医生保护预言家，狼刀预言家 → 预言家存活

---

### 7.8 与猎人交互测试（2 个用例）

27. 医生保护猎人，狼刀猎人 → 猎人存活，不触发开枪
28. 女巫毒杀医生保护的猎人 → 猎人死亡并开枪

---

### 7.9 Edge Cases 测试（5 个用例）

29. 医生自守与连续保护组合验证（四种配置组合）
30. 医生当晚被女巫毒死，当晚保护仍生效
31. 医生选择无效目标（死亡玩家/不存在的 playerId）→ 验证失败
32. 医生在非夜晚阶段提交行动 → 验证失败
33. 医生保护目标同时被狼刀 + 女巫毒 → 死于毒药（医生仅阻止狼刀）

---

### 7.10 多轮游戏测试（2 个用例）

34. 医生连续 5 晚保护不同目标，均成功
35. 医生保护序列：A → B → A → C（`allowRepeatedProtect = false`）

---

**预计测试用例总数**：35 个

---

## 8. 配置建议

在 `frontend/src/games/werewolf/config.json` 中的相关配置项：

```json
{
  "rules": {
    "allowDoctorSelfProtect": true,
    "allowRepeatedProtect": false
  },
  "settingsSchema": {
    "allowDoctorSelfProtect": {
      "type": "boolean",
      "label": "医生可自保",
      "description": "医生是否可以保护自己",
      "default": true,
      "group": "doctor_guard"
    },
    "allowRepeatedProtect": {
      "type": "boolean",
      "label": "允许连续保护",
      "description": "是否允许连续两晚保护同一人",
      "default": false,
      "group": "doctor_guard"
    }
  }
}
```

**注意**：`allowDoctorSelfProtect` 和 `allowRepeatedProtect` 同时被医生和守卫共用。

---

## 9. 实现检查清单

- [ ] 在 `config.json` 的 `roles.p0` 中确认 `doctor` 角色定义
- [ ] 在 `config.json` 的 `nightActionPriority` 中确认 `doctor` 为 priority 7
- [ ] 在 `config.json` 的 `rules` 和 `settingsSchema` 中确认 2 个配置项
- [ ] 在 `rules.js` 中确认 `NIGHT_DOCTOR_PROTECT` 验证逻辑（检查自救、连续保护）
- [ ] 在 `rules-resolution.js` 中确认医生保护结算逻辑（收集 protectedIds，取消 wolf_kill）
- [ ] 在 `ui-panels-roles.js` 中确认 `renderDoctorPanel` 面板渲染
- [ ] 在 `index.js` 中确认 `_getVisibleRoleStates` 暴露 `doctorLastProtect`
- [ ] 在 `index.test.js` 中添加 35 个测试用例
- [ ] 手动测试验证所有 Edge Cases

---

## 10. UI 呈现与交互方式

### 选择模式

`single` — 通过环形座位图点击单个玩家头像选择保护目标。

医生已在 `roleHasNightAction()` 中注册，框架自动通过 `_getNightSelectionConfig()` 提供环形单选。

### 夜间面板内容

面板文件：`ui-panels-roles.js` → `renderDoctorPanel(ctx)`

显示内容：

- **上次保护信息**：若 `doctorLastProtect` 有值，显示"昨晚保护: {玩家名}"
- **连续保护限制提示**：若 `allowRepeatedProtect` 为 false，显示"(今晚不可再选)"
- **当前选择**：若已点选目标，显示"已选择保护: {玩家名}"
- **未选择提示**：显示"点击环形布局中的玩家头像选择要保护的玩家"

### 操作栏按钮

- **确认行动**：选择目标后启用
  - 按钮文案：`确认行动`
  - 启用条件：`selectedTarget !== null`

### 徽章显示

无专属徽章。

### 可见状态字段

`_getVisibleRoleStates` 中暴露给医生玩家：

- `doctorLastProtect`: 上一晚保护的目标 ID

### 白天 UI 影响

无特殊白天 UI 变化。

---

## 11. 参考资料

- **经典狼人杀规则**：[百度百科 - 狼人杀](https://baike.baidu.com/item/狼人杀)
- **类似角色**：守卫（P1）、守护天使（P2）
- **实现参考**：`rules.js` NIGHT_DOCTOR_PROTECT 验证、`rules-resolution.js` 保护结算逻辑

---

**文档版本**：v1.0
**创建日期**：2026-02-22
**作者**：AI-assisted
**待审核**：请确认规则设定是否符合预期
